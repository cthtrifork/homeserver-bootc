name: "Set BootC image vars"
description: "Resolve IMAGE_NAME and related variables based on image type"
inputs:
  image:
    description: "Image selector (homeserver|jumphost|githubrunner|httpsproxy)"
    required: true
runs:
  using: "composite"
  steps:
    - name: Set environment variables
      id: set-env
      shell: bash
      run: | #sh
        set -eo pipefail

        case "${{ inputs.image }}" in
          homeserver)
            IMAGE_NAME="homeserver-centos-bootc"
            CONTAINERFILE="homeserver.containerfile"
            ;;
          homeserver-gui)
            IMAGE_NAME="homeserver-gui-bootc"
            CONTAINERFILE="homeserver-gui.containerfile"
            ;;
          jumphost)
            IMAGE_NAME="jumphost-bootc"
            CONTAINERFILE="jumphost.containerfile"
            ;;
          httpsproxy)
            IMAGE_NAME="httpsproxy-bootc"
            CONTAINERFILE="httpsproxy.containerfile"
            ;;
          githubrunner)
            IMAGE_NAME="github-runner-bootc"
            CONTAINERFILE="github-runner.containerfile"
            ;;
          *)
            echo "Unsupported image type: '${{ inputs.image }}'." >&2
            echo "Expected one of: homeserver, homeserver-gui, jumphost, httpsproxy, githubrunner." >&2
            exit 1
            ;;
        esac
        VERSION="v0.1"
        UNIQUE_VERSION="${{github.ref_name}}-${VERSION}.${{ github.run_number }}" 
        SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-7)"
        DOCKER_TAG=""
        PR_NUMBER='${{ github.event.pull_request.number }}'
        if [ -z "${PR_NUMBER}" ] || [ "${PR_NUMBER}" = "null" ]; then
          DOCKER_TAG="${{github.ref_name}}-${VERSION}" # e.g., main-0.1
        else
          DOCKER_TAG="pr-${PR_NUMBER}-${VERSION}"
        fi
        echo "DOCKER_TAG=${DOCKER_TAG}" >> "$GITHUB_ENV"
        echo "UNIQUE_VERSION=${UNIQUE_VERSION}" >> "$GITHUB_ENV"
        
        echo "IMAGE_NAME=${IMAGE_NAME}" >> "$GITHUB_ENV"
        echo "IMAGE_FULL=ghcr.io/${{ github.repository }}/${IMAGE_NAME}" >> "$GITHUB_ENV"
        echo "LOCAL_PR_IMAGE=localhost/${IMAGE_NAME}:${DOCKER_TAG}" >> "$GITHUB_ENV"
        echo "CONTAINERFILE=${CONTAINERFILE}" >> "$GITHUB_ENV"


