#!/usr/bin/env bash
set -euo pipefail

# SCRIPT VERSION
GROUP_SETUP_VER=1
mkdir -p /etc/homeserver
GROUP_SETUP_VER_FILE="/etc/homeserver/dx-groups"
touch "$GROUP_SETUP_VER_FILE"
GROUP_SETUP_VER_RAN=$(cat "$GROUP_SETUP_VER_FILE")

# Setup Groups
wheelarray=($(getent group wheel | cut -d ":" -f 4 | tr  ',' '\n'))

# Setup home directory for each user in wheel group
for user in $wheelarray
do
  echo "Setting up home for user: $user"
  if [[ ! -d /home/$user ]]; then
    mkdir -m 0700 -p /home/$user/.config
    mkdir -m 0700 -p /home/$user/.docker
    chown -R $user: /home/$user
    echo "Created home directory for $user"
  fi
  bash -u $user -c "setup-home.sh $user"
done

# Run script if updated
if [[ -f $GROUP_SETUP_VER_FILE && "$GROUP_SETUP_VER" = "$GROUP_SETUP_VER_RAN" ]]; then
  echo "Group setup has already run. Exiting..."
  exit 0
fi


for user in $wheelarray
do
  usermod -aG docker $user
  # todo: add more groups here
done

# Prevent future executions
echo "Writing state file"
echo "$GROUP_SETUP_VER" > "$GROUP_SETUP_VER_FILE"

