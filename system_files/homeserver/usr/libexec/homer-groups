#!/usr/bin/env bash
set -euo pipefail

# SCRIPT VERSION
GROUP_SETUP_VER=1
mkdir -p /etc/homeserver

# Setup Groups
wheelarray=($(getent group wheel | cut -d ":" -f 4 | tr ',' '\n'))

BASE=1000001
STEP=100000
SIZE=65536

#mv /etc/subuid /etc/subuid.bak || true
#mv /etc/subgid /etc/subgid.bak || true

# Setup home directory for each user in wheel group
i=0
for user in $wheelarray; do
  echo "Setting up home for user: $user"

  start=$((BASE + i * STEP))
  #echo "$user:$start:$SIZE" | tee -a /etc/subuid /etc/subgid >/dev/null

  #ln -sf /etc/containers/auth.json /home/$user/.config/containers/auth.json
  #ln -sf /usr/lib/container-auth.json /home/$user/.docker/config.json

  sudo -u "$user" -- /usr/libexec/setup-home.sh "$user"
  usermod -aG docker $user

  i=$((i + 1))
done
