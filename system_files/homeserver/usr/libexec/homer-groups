#!/usr/bin/env bash
set -euo pipefail

mkdir -p /etc/homeserver

# Setup Groups
wheelarray=($(getent group wheel | cut -d: -f4 |  tr ',' '\n'))

BASE=1000000
STEP=100000
SIZE=65536

# Ensure system users are present/updated
sudo systemd-sysusers

# Setup home directory for each user in wheel group
i=0
for user in "${wheelarray[@]}"; do
  echo "Setting up home for user: $user"

  start=$((BASE + (i * STEP)))
  echo "$user:$start:$SIZE" | tee -a /etc/subuid /etc/subgid >/dev/null
  # todo: figure out why i need this hack...
  sudo getent passwd caspertdk | sudo tee -a /etc/passwd

  podman system migrate

  #ln -sf /etc/containers/auth.json /home/$user/.config/containers/auth.json
  #ln -sf /usr/lib/container-auth.json /home/$user/.docker/config.json

  /usr/libexec/setup-home.sh "$user"
  sudo usermod -aG docker $user

  i=$((i + 1))
done
